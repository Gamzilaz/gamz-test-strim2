<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–í–∏–¥–µ–æ—Å–≤—è–∑—å –∏ –ß–∞—Ç (WebRTC + Firebase)</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root { color-scheme: dark; }
    /* –°—Ç–∏–ª—å "—Å—Ç–µ–∫–ª–æ" –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ */
    .glass { backdrop-filter: blur(16px); background: rgba(15,23,42,0.8); }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
    .scrollbar::-webkit-scrollbar { width: 8px; }
    .scrollbar::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.6); border-radius: 12px; }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ */
    #localVideo {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 150px;
      height: 100px;
      border-radius: 12px;
      object-fit: cover;
      border: 3px solid rgba(255, 255, 255, 0.4);
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
      cursor: pointer;
    }
    #localVideo:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <!-- –§–æ–Ω —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏ -->
  <div class="fixed inset-0 -z-10 overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-indigo-700/30 via-slate-900 to-fuchsia-800/20"></div>
    <div class="absolute w-[900px] h-[900px] -top-40 -left-40 rounded-full bg-indigo-500/20 blur-[150px]"></div>
    <div class="absolute w-[700px] h-[700px] -bottom-32 -right-32 rounded-full bg-fuchsia-500/20 blur-[150px]"></div>
  </div>

  <header class="flex items-center justify-between px-6 py-4 border-b border-white/10 glass sticky top-0 z-20">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-indigo-500 to-fuchsia-500 flex items-center justify-center font-bold text-xl">üìû</div>
      <div>
        <p class="text-sm uppercase tracking-[0.25em] text-slate-300">–†–µ–∂–∏–º: <span id="authStatus" class="font-semibold text-white">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...</span></p>
        <h1 class="text-2xl font-semibold">WebRTC –°–≤—è–∑—å</h1>
      </div>
    </div>
    <div class="flex items-center gap-3 text-sm">
      <div class="px-3 py-1 rounded-full bg-white/10 border border-white/10">ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <span id="userIdDisplay" class="font-mono text-xs">...</span></div>
      <div class="px-3 py-1 rounded-full bg-red-600/20 border border-red-400/40 text-red-100 hidden" id="connectionStatus">–û–§–§–õ–ê–ô–ù</div>
      <div class="px-3 py-1 rounded-full bg-green-600/20 border border-green-400/40 text-green-100 hidden" id="connectedStatus">–°–û–ï–î–ò–ù–ï–ù–û</div>
    </div>
  </header>

  <main class="grid grid-cols-1 xl:grid-cols-3 gap-6 p-6 max-w-6xl mx-auto">
    <!-- –°–µ–∫—Ü–∏—è –í–∏–¥–µ–æ -->
    <section class="xl:col-span-2 glass border border-white/10 rounded-2xl overflow-hidden shadow-2xl shadow-indigo-900/30">
      <div class="relative aspect-video bg-slate-900 flex items-center justify-center">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –≤–∏–¥–µ–æ (–£–î–ê–õ–ï–ù–ù–´–ô –¥—Ä—É–≥) -->
        <video id="remoteVideo" class="w-full h-full object-cover" autoplay playsinline></video>
        
        <!-- –õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ (–≤–∞—à –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä) -->
        <video id="localVideo" class="hidden" autoplay muted playsinline></video> 

        <div class="absolute inset-0 bg-gradient-to-t from-slate-950/70 to-transparent pointer-events-none"></div>
        <div class="absolute bottom-4 left-4 px-3 py-2 rounded-xl bg-black/50 border border-white/10 text-sm" id="roomLabel">ID –ö–æ–º–Ω–∞—Ç—ã: <span id="currentRoomIdDisplay" class="font-mono">–ù–µ—Ç</span></div>
        <div class="absolute bottom-4 right-4 px-3 py-2 rounded-xl bg-black/40 border border-white/10 text-xs text-slate-200">
          <span id="videoStatusText">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</span>
        </div>
      </div>

      <div class="p-4 border-t border-white/5 flex flex-col md:flex-row items-center justify-between bg-slate-900/60 flex-wrap gap-4">
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–æ–π -->
        <div class="flex items-center gap-3 w-full md:w-auto">
          <input id="roomIdInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-indigo-400/60 w-full md:w-auto min-w-[200px]" />
          <button id="createRoomBtn" class="px-4 py-2 rounded-lg bg-indigo-600 border border-indigo-500 hover:bg-indigo-500 transition shadow-lg shadow-indigo-900/40">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
          <button id="joinRoomBtn" class="px-4 py-2 rounded-lg bg-fuchsia-600 border border-fuchsia-500 hover:bg-fuchsia-500 transition shadow-lg shadow-fuchsia-900/40">üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏–∞ -->
        <div class="flex items-center gap-2 text-sm">
          <button id="camToggleBtn" class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 hover:bg-white/15 transition">üìπ –ö–∞–º–µ—Ä–∞ (–í–ö–õ)</button>
          <button id="micToggleBtn" class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 hover:bg-white/15 transition">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω (–í–ö–õ)</button>
          <button id="hangupBtn" class="px-3 py-1 rounded-lg bg-red-600 border border-red-500 hover:bg-red-500 transition" disabled>‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
      </div>
    </section>

    <!-- –°–µ–∫—Ü–∏—è –ß–∞—Ç -->
    <aside class="glass border border-white/10 rounded-2xl shadow-2xl shadow-indigo-900/30 flex flex-col h-[70vh] xl:h-[82vh]">
      <div class="flex items-center justify-between px-4 py-3 border-b border-white/5">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-slate-400">–ß–∞—Ç</p>
          <h2 class="text-xl font-semibold">–°–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã</h2>
        </div>
        <div class="flex items-center gap-2">
          <select id="userSelect" class="bg-white/10 border border-white/10 rounded-lg px-2 py-1 text-sm focus:outline-none">
            <option>Alex</option>
            <option>Maria</option>
            <option>DevGuru</option>
            <option>Guest</option>
          </select>
          <button id="clearChatBtn" class="text-xs px-2 py-1 rounded bg-white/10 border border-white/10 hover:bg-white/15">–û—á–∏—Å—Ç–∏—Ç—å –õ–æ–∫–∞–ª—å–Ω–æ</button>
        </div>
      </div>

      <div id="chat" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar">
        <p class="text-center text-sm text-slate-500 mt-4">–ß–∞—Ç –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ.</p>
      </div>

      <div class="p-4 border-t border-white/5 space-y-2">
        <div class="flex gap-2">
          <input id="messageInput" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-indigo-400/60" disabled />
          <button id="sendBtn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition shadow-lg shadow-indigo-900/40" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </aside>
  </main>

  <!-- Firebase Import -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, deleteDoc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï FIREBASE ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, auth, db;
    let userId = 'anon';
    let isAuthReady = false;
    const PUBLIC_COLLECTION_PATH = `/artifacts/${appId}/public/data`;
    // ---------------------------------------------------

    // --- –≠–õ–ï–ú–ï–ù–¢–´ DOM (–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ/–ù–æ–≤—ã–µ) ---
    const localVideoEl = document.getElementById('localVideo');
    const remoteVideoEl = document.getElementById('remoteVideo');
    const roomIdInput = document.getElementById('roomIdInput');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const camToggleBtn = document.getElementById('camToggleBtn');
    const micToggleBtn = document.getElementById('micToggleBtn');
    const hangupBtn = document.getElementById('hangupBtn');
    const videoStatusText = document.getElementById('videoStatusText');
    const currentRoomIdDisplay = document.getElementById('currentRoomIdDisplay');
    const connectionStatusEl = document.getElementById('connectionStatus');
    const connectedStatusEl = document.getElementById('connectedStatus');
    const authStatusEl = document.getElementById('authStatus');
    const userIdDisplay = document.getElementById('userIdDisplay');

    const chat = document.getElementById('chat');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const userSelect = document.getElementById('userSelect');
    // ----------------------------------------

    // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï WEBRTC ---
    const configuration = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
      ]
    };

    let peerConnection = null;
    let localStream = null;
    let remoteStream = null;
    let currentRoomId = null;
    let unsubscribeChat = null;
    let unsubscribeRoom = null;
    // -------------------------

    // --- –°–õ–£–ñ–ï–ë–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

    /** –í–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
    function setControlsEnabled(enabled) {
      roomIdInput.disabled = !enabled;
      createRoomBtn.disabled = !enabled;
      joinRoomBtn.disabled = !enabled;
      hangupBtn.disabled = enabled;
      messageInput.disabled = !enabled;
      sendBtn.disabled = !enabled;
    }

    /** –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å UI */
    function updateConnectionState(state) {
        if (state === 'connected') {
            connectionStatusEl.classList.add('hidden');
            connectedStatusEl.classList.remove('hidden');
            videoStatusText.textContent = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ö–æ–º–Ω–∞—Ç–∞: ${currentRoomId}`;
        } else if (state === 'connecting') {
            connectionStatusEl.classList.remove('hidden');
            connectedStatusEl.classList.add('hidden');
            videoStatusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... –û–∂–∏–¥–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.';
        } else { // disconnected
            connectionStatusEl.classList.remove('hidden');
            connectedStatusEl.classList.add('hidden');
            videoStatusText.textContent = currentRoomId ? `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ. –ö–æ–º–Ω–∞—Ç–∞ ${currentRoomId}.` : '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.';
            currentRoomIdDisplay.textContent = currentRoomId || '–ù–µ—Ç';
        }
    }
    
    /** –ü–æ–ª—É—á–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫ (–∫–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω) */
    async function getLocalStream() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { width: { ideal: 640 }, height: { ideal: 480 } },
          audio: true
        });
        localVideoEl.srcObject = localStream;
        localVideoEl.classList.remove('hidden');
        camToggleBtn.textContent = 'üìπ –ö–∞–º–µ—Ä–∞ (–í–ö–õ)';
        micToggleBtn.textContent = 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω (–í–ö–õ)';
      } catch (e) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º:", e);
        videoStatusText.textContent = '–û–®–ò–ë–ö–ê: –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É.';
        // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –ø–æ—Ç–æ–∫, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å WebRTC
        localStream = new MediaStream(); 
        camToggleBtn.textContent = 'üìπ –ö–∞–º–µ—Ä–∞ (–û–¢–ö–õ)';
        micToggleBtn.textContent = 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω (–û–¢–ö–õ)';
      }
    }

    /** –°–±—Ä–æ—Å –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ */
    function hangup() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      if (peerConnection) {
        peerConnection.close();
      }
      if (unsubscribeChat) {
        unsubscribeChat();
      }
      if (unsubscribeRoom) {
        unsubscribeRoom();
      }

      localStream = null;
      peerConnection = null;
      remoteVideoEl.srcObject = null;
      localVideoEl.srcObject = null;
      localVideoEl.classList.add('hidden');
      currentRoomId = null;

      updateConnectionState('disconnected');
      setControlsEnabled(true);
      hangupBtn.disabled = true;
      roomIdInput.value = '';
      chat.innerHTML = '<p class="text-center text-sm text-slate-500 mt-4">–ß–∞—Ç –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ.</p>';
    }

    // --- –õ–û–ì–ò–ö–ê WEBRTC ---

    /** –ù–∞—Å—Ç—Ä–æ–π–∫–∞ RTCPeerConnection */
    function setupPeerConnection(roomId) {
      peerConnection = new RTCPeerConnection(configuration);

      // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –≤ PeerConnection
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
      remoteStream = new MediaStream();
      peerConnection.ontrack = (event) => {
        event.streams[0].getTracks().forEach(track => {
          remoteStream.addTrack(track);
        });
        remoteVideoEl.srcObject = remoteStream;
      };

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      peerConnection.oniceconnectionstatechange = () => {
        console.log('ICE state:', peerConnection.iceConnectionState);
        if (peerConnection.iceConnectionState === 'connected') {
            updateConnectionState('connected');
        } else if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'disconnected') {
            updateConnectionState('connecting'); // –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–º, –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑
        } else if (peerConnection.iceConnectionState === 'closed') {
            hangup();
        }
      };

      // –°–ª—É—à–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö –≤ Firestore
      const roomRef = doc(db, PUBLIC_COLLECTION_PATH, 'rooms', roomId);
      const candidatesCollection = collection(roomRef, 'candidates');

      peerConnection.onicecandidate = async (event) => {
        if (event.candidate) {
          console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:', event.candidate);
          await addDoc(candidatesCollection, event.candidate.toJSON());
        }
      };
    }

    /** 1. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã (Offer) */
    async function createRoom() {
      if (!isAuthReady) return alert('–û—à–∏–±–∫–∞: –û–∂–∏–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.');
      
      await getLocalStream();
      const roomId = Math.random().toString(36).substring(2, 9);
      currentRoomId = roomId;
      setupPeerConnection(roomId);
      setControlsEnabled(false);
      hangupBtn.disabled = false;
      
      currentRoomIdDisplay.textContent = roomId;
      updateConnectionState('connecting');

      const roomRef = doc(db, PUBLIC_COLLECTION_PATH, 'rooms', roomId);
      const offerCandidatesCollection = collection(roomRef, 'offerCandidates');
      const answerCandidatesCollection = collection(roomRef, 'answerCandidates');

      // –°–æ–∑–¥–∞–µ–º Offer
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      
      console.log('–°–æ–∑–¥–∞–Ω Offer, –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ Firestore.');

      const roomWithOffer = {
        offer: {
          type: offer.type,
          sdp: offer.sdp,
        },
        createdAt: serverTimestamp(),
        creatorId: userId,
      };

      await setDoc(roomRef, roomWithOffer);
      
      // –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å Answer
      unsubscribeRoom = onSnapshot(roomRef, async (snapshot) => {
        const data = snapshot.data();
        if (data && data.answer && !peerConnection.currentRemoteDescription) {
          console.log('–ü–æ–ª—É—á–µ–Ω Answer, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.');
          const answerDesc = new RTCSessionDescription(data.answer);
          await peerConnection.setRemoteDescription(answerDesc);
          
          // –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –æ—Ç –æ—Ç–≤–µ—á–∞—é—â–µ–≥–æ
          unsubscribeRoom(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
          listenForCandidates(answerCandidatesCollection);
        }
      });
      
      // –°–ª—É—à–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –æ—Ç —Å–æ–∑–¥–∞—é—â–µ–≥–æ
      listenForCandidates(offerCandidatesCollection);

      // –ó–∞–ø—É—Å–∫–∞–µ–º —á–∞—Ç
      setupChat(roomId);
    }

    /** 2. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ (Answer) */
    async function joinRoom() {
      if (!isAuthReady) return alert('–û—à–∏–±–∫–∞: –û–∂–∏–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.');
      const roomId = roomIdInput.value.trim();
      if (!roomId) return alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã.');

      await getLocalStream();
      currentRoomId = roomId;
      setupPeerConnection(roomId);
      setControlsEnabled(false);
      hangupBtn.disabled = false;
      
      currentRoomIdDisplay.textContent = roomId;
      updateConnectionState('connecting');

      const roomRef = doc(db, PUBLIC_COLLECTION_PATH, 'rooms', roomId);
      const offerCandidatesCollection = collection(roomRef, 'offerCandidates');
      const answerCandidatesCollection = collection(roomRef, 'answerCandidates');
      
      const roomSnapshot = await getDoc(roomRef);
      if (!roomSnapshot.exists()) {
        alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
        hangup();
        return;
      }
      
      const offer = roomSnapshot.data().offer;
      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
      
      // –°–æ–∑–¥–∞–µ–º Answer
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);

      const roomWithAnswer = {
        answer: {
          type: answer.type,
          sdp: answer.sdp,
        },
        joinedAt: serverTimestamp(),
        joinerId: userId,
      };

      await updateDoc(roomRef, roomWithAnswer);
      console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω Answer.');

      // –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
      listenForCandidates(offerCandidatesCollection);
      listenForCandidates(answerCandidatesCollection);

      // –ó–∞–ø—É—Å–∫–∞–µ–º —á–∞—Ç
      setupChat(roomId);
    }

    /** –°–ª—É—à–∞—Ç–µ–ª—å ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ */
    function listenForCandidates(collectionRef) {
      onSnapshot(collectionRef, (snapshot) => {
        snapshot.docChanges().forEach(async (change) => {
          if (change.type === 'added') {
            const candidate = new RTCIceCandidate(change.doc.data());
            try {
              await peerConnection.addIceCandidate(candidate);
              console.log('–î–æ–±–∞–≤–ª–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç:', candidate);
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:', e);
            }
          }
        });
      });
    }

    // --- –õ–û–ì–ò–ö–ê –ß–ê–¢–ê (Firestore) ---

    const badges = {
      Alex: '–í–µ–¥—É—â–∏–π',
      Maria: '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä',
      DevGuru: '–ü–æ–¥–ø–∏—Å—á–∏–∫',
      Guest: '–ì–æ—Å—Ç—å'
    };

    const colors = {
      Alex: 'from-indigo-500 to-fuchsia-500',
      Maria: 'from-emerald-500 to-cyan-500',
      DevGuru: 'from-amber-500 to-orange-500',
      Guest: 'from-slate-500 to-slate-700'
    };
    
    function renderMessage(user, text, timestamp) {
      const wrap = document.createElement('div');
      wrap.className = 'p-3 rounded-xl bg-white/5 border border-white/5 shadow-sm shadow-black/20';

      const head = document.createElement('div');
      head.className = 'flex items-center justify-between mb-1';

      const userInfo = document.createElement('div');
      userInfo.className = 'flex items-center gap-2';

      const avatar = document.createElement('div');
      avatar.className = `h-8 w-8 rounded-full bg-gradient-to-br ${colors[user] || 'from-slate-500 to-slate-700'} flex items-center justify-center text-xs font-semibold uppercase flex-shrink-0`;
      avatar.textContent = user.slice(0, 2);

      const name = document.createElement('div');
      name.className = 'flex items-center gap-2 truncate';
      const userEl = document.createElement('span');
      userEl.className = 'font-semibold';
      userEl.textContent = user;
      const badge = document.createElement('span');
      badge.className = 'text-[11px] px-2 py-[2px] rounded-full bg-white/10 border border-white/10 text-slate-200 flex-shrink-0';
      badge.textContent = badges[user] || '–ó—Ä–∏—Ç–µ–ª—å';
      name.append(userEl, badge);
      userInfo.append(avatar, name);

      const timeEl = document.createElement('span');
      timeEl.className = 'text-xs text-slate-500 flex-shrink-0';
      if (timestamp) {
        timeEl.textContent = new Date(timestamp.seconds * 1000).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      }

      head.append(userInfo, timeEl);

      const body = document.createElement('p');
      body.className = 'text-sm text-slate-200 leading-relaxed break-words';
      body.textContent = text;

      wrap.append(head, body);
      chat.appendChild(wrap);
      chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });
    }

    /** –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Firestore */
    async function sendMessage() {
      const text = messageInput.value.trim();
      const user = userSelect.value;
      if (!text || !currentRoomId) return;

      try {
        const chatCollectionRef = collection(db, PUBLIC_COLLECTION_PATH, 'rooms', currentRoomId, 'messages');
        await addDoc(chatCollectionRef, {
          user: user,
          text: text,
          userId: userId,
          timestamp: serverTimestamp(),
        });
        messageInput.value = '';
        messageInput.focus();
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:", e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore.');
      }
    }

    /** –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —á–∞—Ç–∞ Firestore */
    function setupChat(roomId) {
      chat.innerHTML = '';
      const chatCollectionRef = collection(db, PUBLIC_COLLECTION_PATH, 'rooms', roomId, 'messages');
      // –ó–∞–ø—Ä–æ—Å —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ timestamp
      const q = query(chatCollectionRef, orderBy('timestamp'));

      unsubscribeChat = onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'added') {
            const data = change.doc.data();
            renderMessage(data.user, data.text, data.timestamp);
          }
        });
      }, (error) => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —á–∞—Ç–∞:", error);
      });
    }

    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ï–î–ò–ê ---

    createRoomBtn.addEventListener('click', createRoom);
    joinRoomBtn.addEventListener('click', joinRoom);
    hangupBtn.addEventListener('click', hangup);
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    camToggleBtn.addEventListener('click', () => {
        if (!localStream) return;
        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            camToggleBtn.textContent = videoTrack.enabled ? 'üìπ –ö–∞–º–µ—Ä–∞ (–í–ö–õ)' : 'üìπ –ö–∞–º–µ—Ä–∞ (–û–¢–ö–õ)';
        }
    });

    micToggleBtn.addEventListener('click', () => {
        if (!localStream) return;
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            micToggleBtn.textContent = audioTrack.enabled ? 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω (–í–ö–õ)' : 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω (–û–¢–ö–õ)';
        }
    });

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ---

    async function initializeFirebase() {
      authStatusEl.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥.
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            isAuthReady = true;
            authStatusEl.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
            userIdDisplay.textContent = userId.substring(0, 8) + '...';
            console.log("Firebase/Auth –≥–æ—Ç–æ–≤. User ID:", userId);
            updateConnectionState('disconnected'); // –°–±—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞
          } else {
            authStatusEl.textContent = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
            console.error("Firebase/Auth –Ω–µ –≥–æ—Ç–æ–≤.");
          }
        });
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", e);
        authStatusEl.textContent = '–û–®–ò–ë–ö–ê FIREBASE';
      }
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    window.onload = initializeFirebase;
    setControlsEnabled(true); // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç—å/–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
  </script>
</body>
</html>
