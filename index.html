<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°—Ç—Ä–∏–º —Å —á–∞—Ç–æ–º –∏ —Å–æ–∑–≤–æ–Ω–æ–º</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    body {
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
    }
    .glass {
      background: rgba(15, 23, 42, 0.75);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .scroll-thin::-webkit-scrollbar {
      width: 6px;
    }
    .scroll-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    .scroll-thin::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: 999px;
    }
    video {
      background: #020617;
    }
  </style>
</head>
<body class="min-h-screen text-slate-100 flex flex-col">
  <header class="px-4 sm:px-8 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="h-9 w-9 rounded-xl bg-gradient-to-tr from-indigo-500 via-sky-500 to-emerald-400 flex items-center justify-center text-xs font-bold tracking-tight">
        LIVE
      </div>
      <div>
        <h1 class="text-lg sm:text-2xl font-semibold tracking-tight">–ú–æ–π —Å—Ç—Ä–∏–º + —Å–æ–∑–≤–æ–Ω —Å –¥—Ä—É–≥–æ–º</h1>
        <p class="text-xs sm:text-sm text-slate-400">–ö–∞–º–µ—Ä–∞, —á–∞—Ç –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</p>
      </div>
    </div>
    <div class="hidden sm:flex items-center gap-3 text-xs text-slate-300">
      <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-slate-900/70 border border-slate-600/60">
        <span class="relative flex h-2.5 w-2.5 mr-0.5">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-500 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-rose-500"></span>
        </span>
        <span class="font-medium">Live</span>
      </div>
      <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-slate-900/70 border border-slate-700/70">
        <span class="inline-flex h-2 w-2 rounded-full bg-emerald-400"></span>
        <span>–ó—Ä–∏—Ç–µ–ª–µ–π: <span id="viewerCount" class="font-semibold">1</span></span>
      </div>
    </div>
  </header>

  <main class="flex-1 px-4 sm:px-8 pb-6 flex flex-col lg:flex-row gap-4 sm:gap-6">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç—Ä–∏–º + —Å–æ–∑–≤–æ–Ω -->
    <section class="flex-1 flex flex-col gap-4 min-w-0">
      <!-- –ú–æ–π —Å—Ç—Ä–∏–º -->
      <div class="glass rounded-3xl p-3 sm:p-4 shadow-xl flex flex-col gap-3">
        <div class="flex items-center justify-between mb-1">
          <div>
            <h2 class="text-base sm:text-lg font-semibold tracking-tight flex items-center gap-2">
              <span class="inline-flex h-2.5 w-2.5 rounded-full bg-rose-500 shadow-[0_0_15px_rgba(248,113,113,0.9)]"></span>
              –ú–æ—è –∫–∞–º–µ—Ä–∞ (—Å—Ç—Ä–∏–º)
            </h2>
            <p class="text-xs sm:text-sm text-slate-400">–ö–∞—Ä—Ç–∏–Ω–∫–∞, –∫–æ—Ç–æ—Ä—É—é –≤–∏–¥–∏—Ç–µ –≤—ã –∏ –≤–∞—à–∏ –∑—Ä–∏—Ç–µ–ª–∏</p>
          </div>
          <button id="toggleCamera" class="px-3 py-1.5 rounded-full bg-indigo-500 hover:bg-indigo-600 active:bg-indigo-700 text-xs sm:text-sm font-medium shadow-lg shadow-indigo-500/30 transition flex items-center gap-1.5">
            <span id="cameraBtnDot" class="inline-flex h-2 w-2 rounded-full bg-emerald-400"></span>
            <span id="cameraBtnLabel">–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</span>
          </button>
        </div>
        <div class="relative rounded-2xl overflow-hidden border border-slate-700/70 bg-black aspect-video max-h-[60vh]">
          <video id="localVideo" class="w-full h-full object-cover" autoplay playsinline muted></video>
          <div id="localVideoOverlay" class="absolute inset-0 flex flex-col items-center justify-center text-center text-slate-300 text-xs sm:text-sm px-4 pointer-events-none">
            <p class="font-medium mb-1">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Å–µ–±—è –≤ —Å—Ç—Ä–∏–º–µ.</p>
            <p class="text-slate-400">–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –Ω–∞–∂–º–∏—Ç–µ ¬´–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É¬ª –µ—â—ë —Ä–∞–∑.</p>
          </div>
          <div class="absolute top-3 left-3 flex items-center gap-2 text-[10px] sm:text-xs px-2 py-1 rounded-full bg-black/70 border border-slate-700/80">
            <span class="inline-flex h-2 w-2 rounded-full bg-rose-500"></span>
            <span>LIVE ‚Ä¢ <span id="streamResolution">‚Äî</span></span>
          </div>
          <div class="absolute bottom-3 right-3 flex items-center gap-2">
            <button id="muteToggle" class="h-8 w-8 rounded-full bg-black/70 hover:bg-black/90 text-slate-200 flex items-center justify-center text-lg leading-none border border-slate-600/80 transition" title="–í–∫–ª/–≤—ã–∫–ª –∑–≤—É–∫ –Ω–∞ —Å—Ç—Ä–∏–º–µ (–¥–ª—è –∑—Ä–∏—Ç–µ–ª–µ–π)">
              üîá
            </button>
            <button id="pipToggle" class="h-8 w-8 rounded-full bg-black/70 hover:bg-black/90 text-slate-200 flex items-center justify-center text-xs border border-slate-600/80 transition" title="–ö–∞—Ä—Ç–∏–Ω–∫–∞-–≤-–∫–∞—Ä—Ç–∏–Ω–∫–µ">
              PiP
            </button>
            <button id="fsToggle" class="h-8 w-8 rounded-full bg-black/70 hover:bg-black/90 text-slate-200 flex items-center justify-center text-base border border-slate-600/80 transition" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">
              ‚õ∂
            </button>
          </div>
        </div>
      </div>

      <!-- –°–æ–∑–≤–æ–Ω —Å –¥—Ä—É–≥–æ–º (WebRTC) -->
      <div class="glass rounded-3xl p-3 sm:p-4 shadow-xl flex flex-col gap-3">
        <div class="flex items-center justify-between mb-1">
          <div>
            <h2 class="text-base sm:text-lg font-semibold tracking-tight">–°–æ–∑–≤–æ–Ω —Å –¥—Ä—É–≥–æ–º (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ)</h2>
            <p class="text-xs sm:text-sm text-slate-400">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É —Å—Å—ã–ª–∫—É –Ω–∞ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—â–∏–π –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã.</p>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <!-- –ú–æ–π –ø–æ—Ç–æ–∫ –¥–ª—è –∑–≤–æ–Ω–∫–∞ -->
          <div class="space-y-2">
            <p class="text-xs text-slate-400">–í—ã –≤ –∑–≤–æ–Ω–∫–µ</p>
            <div class="relative rounded-2xl overflow-hidden border border-slate-700/70 bg-black aspect-video">
              <video id="callLocalVideo" class="w-full h-full object-cover" autoplay playsinline muted></video>
              <div class="absolute top-2 left-2 text-[10px] px-2 py-1 rounded-full bg-black/70 border border-slate-700/80 text-slate-200">
                –í—ã
              </div>
            </div>
          </div>
          <!-- –î—Ä—É–≥ -->
          <div class="space-y-2">
            <p class="text-xs text-slate-400">–î—Ä—É–≥</p>
            <div class="relative rounded-2xl overflow-hidden border border-slate-700/70 bg-black aspect-video">
              <video id="remoteVideo" class="w-full h-full object-cover" autoplay playsinline></video>
              <div class="absolute top-2 left-2 text-[10px] px-2 py-1 rounded-full bg-black/70 border border-slate-700/80 text-slate-200">
                –î—Ä—É–≥
              </div>
              <div id="remotePlaceholder" class="absolute inset-0 flex items-center justify-center text-center text-xs text-slate-400 px-3">
                –û–∂–∏–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥—Ä—É–≥–∞‚Ä¶ –û–Ω —É–≤–∏–¥–∏—Ç –≤–∞—à –∑–∞–ø—Ä–æ—Å, –∫–æ–≥–¥–∞ –≤–≤–µ–¥—ë—Ç —Ç–æ—Ç –∂–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã.
              </div>
            </div>
          </div>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤–æ–Ω–∫–æ–º -->
        <div class="mt-2 border-t border-slate-700/70 pt-3 flex flex-col gap-2 text-xs sm:text-sm">
          <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
            <div class="flex-1 flex items-center gap-2">
              <label for="roomCode" class="whitespace-nowrap text-slate-300">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</label>
              <input id="roomCode" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, my-room-123" class="flex-1 px-2 py-1 rounded-lg bg-slate-900/80 border border-slate-700/80 text-xs sm:text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
            <div class="flex gap-2">
              <button id="createOffer" class="px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-600 active:bg-emerald-700 text-xs sm:text-sm font-medium transition">–°–æ–∑–¥–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
              <button id="answerOffer" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 active:bg-slate-500 text-xs sm:text-sm font-medium transition">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
              <button id="hangupCall" class="px-3 py-1.5 rounded-lg bg-rose-600 hover:bg-rose-700 active:bg-rose-800 text-xs sm:text-sm font-medium transition">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>
          </div>
          <p class="text-[11px] sm:text-xs text-slate-400">
            –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: –≤—ã–±–µ—Ä–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π <span class="font-semibold">–∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</span> –∏ –¥–æ–≥–æ–≤–æ—Ä–∏—Ç–µ—Å—å –æ –Ω—ë–º —Å –¥—Ä—É–≥–æ–º. –û–¥–∏–Ω –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–°–æ–∑–¥–∞—Ç—å –∑–≤–æ–Ω–æ–∫¬ª, –≤—Ç–æ—Ä–æ–π ‚Äî ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è¬ª. –î–ª—è –æ–±–º–µ–Ω–∞ —Å–ª—É–∂–µ–±–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ <span class="font-mono">localStorage</span> –≤ —Ä–∞–º–∫–∞—Ö —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç—ã (–ø–æ–¥—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤, –Ω–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞).
          </p>
          <p id="callStatus" class="text-[11px] sm:text-xs text-slate-300"></p>
        </div>
      </div>
    </section>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —á–∞—Ç -->
    <aside class="w-full lg:w-80 xl:w-96 glass rounded-3xl p-3 sm:p-4 shadow-xl flex flex-col max-h-[80vh]">
      <div class="flex items-center justify-between mb-2">
        <div>
          <h2 class="text-base sm:text-lg font-semibold tracking-tight">–ß–∞—Ç</h2>
          <p class="text-xs text-slate-400">–û–±—â–µ–Ω–∏–µ —Å–æ –∑—Ä–∏—Ç–µ–ª—è–º–∏ –≤–æ –≤—Ä–µ–º—è —Å—Ç—Ä–∏–º–∞</p>
        </div>
        <div class="flex items-center gap-2 text-[11px] text-slate-400">
          <label class="flex items-center gap-1">
            <span>–Ø –∫–∞–∫</span>
            <select id="userRole" class="bg-slate-900/80 border border-slate-700/80 rounded-full px-2 py-0.5 text-[11px] focus:outline-none focus:ring-1 focus:ring-indigo-500">
              <option value="host">–°—Ç—Ä–∏–º–µ—Ä</option>
              <option value="viewer">–ó—Ä–∏—Ç–µ–ª—å</option>
            </select>
          </label>
        </div>
      </div>

      <div id="chatMessages" class="flex-1 overflow-y-auto scroll-thin space-y-2 pr-1 text-xs sm:text-sm">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
      </div>

      <div class="mt-2 border-t border-slate-700/70 pt-2 flex flex-col gap-2">
        <div class="flex gap-2">
          <input
            id="chatInput"
            type="text"
            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ Enter‚Ä¶"
            class="flex-1 px-3 py-1.5 rounded-full bg-slate-900/80 border border-slate-700/80 text-xs sm:text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
          <button
            id="sendBtn"
            class="px-3 py-1.5 rounded-full bg-indigo-500 hover:bg-indigo-600 active:bg-indigo-700 text-xs sm:text-sm font-medium transition"
          >
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
          </button>
        </div>
        <div class="flex items-center justify-between text-[11px] text-slate-500">
          <span>Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞</span>
          <button id="clearChat" class="text-slate-400 hover:text-rose-400 transition">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
        </div>
      </div>
    </aside>
  </main>

  <footer class="px-4 sm:px-8 py-3 text-[11px] sm:text-xs text-slate-500 flex items-center justify-between border-t border-slate-800/80">
    <span>–õ–æ–∫–∞–ª—å–Ω—ã–π –¥–µ–º–æ-—Å—Ç—Ä–∏–º + WebRTC —Å–æ–∑–≤–æ–Ω (—Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ / –≤–∫–ª–∞–¥–∫–µ).</span>
    <span>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞.</span>
  </footer>

  <script>
    // ====================== –ë–õ–û–ö: –°–¢–†–ò–ú (–ú–û–Ø –ö–ê–ú–ï–†–ê) ======================
    const localVideo = document.getElementById('localVideo');
    const localVideoOverlay = document.getElementById('localVideoOverlay');
    const toggleCameraBtn = document.getElementById('toggleCamera');
    const cameraBtnLabel = document.getElementById('cameraBtnLabel');
    const cameraBtnDot = document.getElementById('cameraBtnDot');
    const streamResolutionEl = document.getElementById('streamResolution');
    const muteToggle = document.getElementById('muteToggle');
    const pipToggle = document.getElementById('pipToggle');
    const fsToggle = document.getElementById('fsToggle');
    const viewerCountEl = document.getElementById('viewerCount');

    let localStream = null;
    let isMuted = true; // –¥–ª—è –∑—Ä–∏—Ç–µ–ª–µ–π (–ø–æ —Å—É—Ç–∏ –≤—ã–∫–ª—é—á–∞–µ–º –∞—É–¥–∏–æ —Ç—Ä–µ–∫–∏)

    async function startLocalStream() {
      try {
        if (localStream) {
          localStream.getTracks().forEach(t => t.stop());
        }
        const constraints = {
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            frameRate: { ideal: 30 }
          },
          audio: true
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        localStream = stream;
        localVideo.srcObject = stream;
        localVideoOverlay.classList.add('hidden');
        cameraBtnLabel.textContent = '–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É';
        cameraBtnDot.classList.remove('bg-rose-500');
        cameraBtnDot.classList.add('bg-emerald-400');

        const videoTrack = stream.getVideoTracks()[0];
        if (videoTrack) {
          const s = videoTrack.getSettings();
          streamResolutionEl.textContent = `${s.width || ''}√ó${s.height || ''}`.trim() || '–∫–∞–º–µ—Ä–∞';
        } else {
          streamResolutionEl.textContent = '–∫–∞–º–µ—Ä–∞';
        }

        updateAudioState();
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É', err);
        localVideoOverlay.classList.remove('hidden');
        localVideoOverlay.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.';
        cameraBtnLabel.textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É';
        cameraBtnDot.classList.remove('bg-emerald-400');
        cameraBtnDot.classList.add('bg-rose-500');
        streamResolutionEl.textContent = '–æ—à–∏–±–∫–∞';
      }
    }

    function updateAudioState() {
      if (!localStream) return;
      localStream.getAudioTracks().forEach(track => {
        track.enabled = !isMuted;
      });
      muteToggle.textContent = isMuted ? 'üîá' : 'üîä';
    }

    toggleCameraBtn.addEventListener('click', startLocalStream);

    muteToggle.addEventListener('click', () => {
      isMuted = !isMuted;
      updateAudioState();
    });

    pipToggle.addEventListener('click', async () => {
      try {
        if (document.pictureInPictureElement) {
          await document.exitPictureInPicture();
        } else if (localVideo.requestPictureInPicture) {
          await localVideo.requestPictureInPicture();
        }
      } catch (err) {
        console.error('PiP error', err);
      }
    });

    fsToggle.addEventListener('click', () => {
      const container = localVideo.parentElement;
      if (!document.fullscreenElement) {
        container.requestFullscreen?.();
      } else {
        document.exitFullscreen?.();
      }
    });

    // –ò–º–∏—Ç–∏—Ä—É–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ –∫–æ–ª-–≤–æ –∑—Ä–∏—Ç–µ–ª–µ–π
    function simulateViewers() {
      const base = 1 + Math.floor(Math.random() * 3);
      viewerCountEl.textContent = base.toString();
    }
    simulateViewers();
    setInterval(simulateViewers, 15000);

    // –ê–≤—Ç–æ-–∑–∞–ø—É—Å–∫ –ø–æ–ø—ã—Ç–∫–∏ –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
    if (navigator.mediaDevices?.getUserMedia) {
      startLocalStream();
    } else {
      localVideoOverlay.textContent = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç getUserMedia. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π Chromium/Firefox/Safari.';
    }

    // ====================== –ë–õ–û–ö: –ß–ê–¢ ======================
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const clearChatBtn = document.getElementById('clearChat');
    const userRoleSelect = document.getElementById('userRole');

    const initialMessages = [
      { role: 'viewer', name: 'Alex', text: '–ü—Ä–∏–≤–µ—Ç! –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∏ –∑–≤—É–∫ –µ—Å—Ç—å üëç' },
      { role: 'host', name: '–í—ã', text: '–û—Ç–ª–∏—á–Ω–æ! –ï—Å–ª–∏ —á—Ç–æ, –ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –≤ —á–∞—Ç.' },
      { role: 'viewer', name: 'Mira', text: '–°–¥–µ–ª–∞–π —á—É—Ç—å –≥—Ä–æ–º—á–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.' }
    ];

    function createMessageElement({ role, name, text, self = false }) {
      const wrapper = document.createElement('div');
      wrapper.className = 'flex flex-col gap-0.5';

      const header = document.createElement('div');
      header.className = 'flex items-center gap-1.5 text-[11px]';

      const nameSpan = document.createElement('span');
      nameSpan.textContent = name;
      nameSpan.className = 'font-medium ' + (role === 'host' ? 'text-emerald-300' : 'text-sky-300');

      const badge = document.createElement('span');
      badge.className = 'px-1.5 py-0.5 rounded-full text-[10px] border';
      if (role === 'host') {
        badge.textContent = '–°—Ç—Ä–∏–º–µ—Ä';
        badge.classList.add('bg-emerald-500/10', 'border-emerald-400/60', 'text-emerald-200');
      } else {
        badge.textContent = '–ó—Ä–∏—Ç–µ–ª—å';
        badge.classList.add('bg-sky-500/10', 'border-sky-400/60', 'text-sky-200');
      }

      const time = document.createElement('span');
      const now = new Date();
      time.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      time.className = 'text-[10px] text-slate-500 ml-auto';

      header.appendChild(nameSpan);
      header.appendChild(badge);
      header.appendChild(time);

      const body = document.createElement('div');
      body.className = 'px-2.5 py-1.5 rounded-2xl text-[12px] sm:text-xs max-w-full break-words border';
      if (role === 'host') {
        body.classList.add('bg-emerald-500/10', 'border-emerald-500/30');
      } else if (self) {
        body.classList.add('bg-indigo-500/10', 'border-indigo-500/30');
      } else {
        body.classList.add('bg-slate-800/80', 'border-slate-600/60');
      }
      body.textContent = text;

      wrapper.appendChild(header);
      wrapper.appendChild(body);
      return wrapper;
    }

    function addMessage(msg) {
      const el = createMessageElement(msg);
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    initialMessages.forEach(addMessage);

    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      const role = userRoleSelect.value;
      const isHost = role === 'host';
      addMessage({
        role,
        name: isHost ? '–í—ã' : '–ì–æ—Å—Ç—å',
        text,
        self: true
      });
      chatInput.value = '';
      chatInput.focus();
    }

    sendBtn.addEventListener('click', sendMessage);

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    clearChatBtn.addEventListener('click', () => {
      chatMessages.innerHTML = '';
    });

    // ====================== –ë–õ–û–ö: WEBRTC –°–û–ó–í–û–ù ======================
    const callLocalVideo = document.getElementById('callLocalVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const remotePlaceholder = document.getElementById('remotePlaceholder');
    const roomCodeInput = document.getElementById('roomCode');
    const createOfferBtn = document.getElementById('createOffer');
    const answerOfferBtn = document.getElementById('answerOffer');
    const hangupCallBtn = document.getElementById('hangupCall');
    const callStatusEl = document.getElementById('callStatus');

    let callLocalStream = null;
    let peerConnection = null;
    let callRoomKey = null;

    const rtcConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
      ]
    };

    function logStatus(text) {
      console.log('[CALL]', text);
      callStatusEl.textContent = text;
    }

    async function getCallMediaStream() {
      if (callLocalStream) return callLocalStream;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        callLocalStream = stream;
        callLocalVideo.srcObject = stream;
        return stream;
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞ –¥–ª—è –∑–≤–æ–Ω–∫–∞', err);
        logStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è –∑–≤–æ–Ω–∫–∞.');
        throw err;
      }
    }

    function cleanupCall() {
      if (peerConnection) {
        peerConnection.onicecandidate = null;
        peerConnection.ontrack = null;
        peerConnection.onconnectionstatechange = null;
        peerConnection.close();
      }
      peerConnection = null;
      if (remoteVideo.srcObject) {
        remoteVideo.srcObject.getTracks().forEach(t => t.stop());
      }
      remoteVideo.srcObject = null;
      remotePlaceholder.classList.remove('hidden');
      if (callLocalStream) {
        // –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–≤–∞–ª—Å—è —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –∫–∞–º–µ—Ä–æ–π –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∑–≤–æ–Ω–∫–∞
        callLocalVideo.srcObject = callLocalStream;
      }
      if (callRoomKey) {
        localStorage.removeItem(callRoomKey + ':offer');
        localStorage.removeItem(callRoomKey + ':answer');
        localStorage.removeItem(callRoomKey + ':ice');
      }
      logStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω.');
    }

    function getRoomKey() {
      const code = roomCodeInput.value.trim();
      if (!code) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã');
        return null;
      }
      return 'demo-call-room:' + code;
    }

    function subscribeToStorageEvents() {
      window.addEventListener('storage', async (e) => {
        if (!callRoomKey || !peerConnection) return;
        if (!e.key || !e.key.startsWith(callRoomKey)) return;

        if (e.key.endsWith(':offer')) {
          // –ü–æ–ª—É—á–∏–ª–∏ –æ—Ñ—Ñ–µ—Ä –æ—Ç –¥—Ä—É–≥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
          if (!localStorage.getItem(callRoomKey + ':answer')) {
            const offer = JSON.parse(e.newValue);
            logStatus('–ü–æ–ª—É—á–µ–Ω –æ—Ñ—Ñ–µ—Ä, —Å–æ–∑–¥–∞—ë–º –æ—Ç–≤–µ—Ç‚Ä¶');
            await handleRemoteOffer(offer);
          }
        } else if (e.key.endsWith(':answer')) {
          // –ü–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç
          const answer = JSON.parse(e.newValue);
          logStatus('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º‚Ä¶');
          await peerConnection.setRemoteDescription(answer);
        } else if (e.key.endsWith(':ice')) {
          const list = JSON.parse(e.newValue || '[]');
          for (const cand of list) {
            try {
              await peerConnection.addIceCandidate(cand);
            } catch (err) {
              console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE', err);
            }
          }
        }
      });
    }

    function writeIceCandidate(candidate) {
      if (!callRoomKey) return;
      const key = callRoomKey + ':ice';
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      list.push(candidate);
      localStorage.setItem(key, JSON.stringify(list));
    }

    async function createPeerConnection() {
      if (peerConnection) return peerConnection;
      peerConnection = new RTCPeerConnection(rtcConfig);

      const stream = await getCallMediaStream();
      stream.getTracks().forEach(track => {
        peerConnection.addTrack(track, stream);
      });

      peerConnection.ontrack = (event) => {
        if (!remoteVideo.srcObject) {
          remoteVideo.srcObject = event.streams[0];
        }
        remotePlaceholder.classList.add('hidden');
      };

      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          writeIceCandidate(event.candidate.toJSON());
        }
      };

      peerConnection.onconnectionstatechange = () => {
        logStatus('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + peerConnection.connectionState);
        if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'closed') {
          // –ê–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ
          // cleanupCall(); // –º–æ–∂–Ω–æ –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ—à–∞–ª —Å–∞–º
        }
      };

      return peerConnection;
    }

    async function startOfferFlow() {
      const key = getRoomKey();
      if (!key) return;
      callRoomKey = key;
      logStatus('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –∑–≤–æ–Ω–∫–∞‚Ä¶');
      await getCallMediaStream();
      await createPeerConnection();

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      localStorage.setItem(callRoomKey + ':offer', JSON.stringify(offer));
      logStatus('–û–∂–∏–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥—Ä—É–≥–∞. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É —Ç–æ—Ç –∂–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã.');
    }

    async function handleRemoteOffer(offer) {
      if (!peerConnection) {
        await getCallMediaStream();
        await createPeerConnection();
      }
      await peerConnection.setRemoteDescription(offer);
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      localStorage.setItem(callRoomKey + ':answer', JSON.stringify(answer));
      logStatus('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û–∂–∏–¥–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è‚Ä¶');
    }

    async function startAnswerFlow() {
      const key = getRoomKey();
      if (!key) return;
      callRoomKey = key;
      await getCallMediaStream();
      await createPeerConnection();

      const offerRaw = localStorage.getItem(callRoomKey + ':offer');
      if (offerRaw) {
        const offer = JSON.parse(offerRaw);
        await handleRemoteOffer(offer);
      } else {
        logStatus('–û—Ñ—Ñ–µ—Ä –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –¥—Ä—É–≥–∞ –Ω–∞–∂–∞—Ç—å ¬´–°–æ–∑–¥–∞—Ç—å –∑–≤–æ–Ω–æ–∫¬ª –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      }
    }

    createOfferBtn.addEventListener('click', startOfferFlow);
    answerOfferBtn.addEventListener('click', startAnswerFlow);
    hangupCallBtn.addEventListener('click', cleanupCall);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã –¥–ª—è –±–ª–æ–∫–∞ –∑–≤–æ–Ω–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
    if (navigator.mediaDevices?.getUserMedia) {
      getCallMediaStream().catch(() => {});
    } else {
      logStatus('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC / getUserMedia.');
    }

    subscribeToStorageEvents();
  </script>
</body>
</html>
